{"version":3,"file":"token-resizer.js","sources":["../src/module/util/setup/hooks.ts","../src/module/token-resizer.ts"],"sourcesContent":["async function changeTokensSizeIfInTheSameGridPosition(token: TokenDocument, changes: any) {\n  if (changes.x === undefined && changes.y === undefined) return;\n  if (!game.user?.isGM) return;\n\n  const newGridPosition: PointArray | { x: number; y: number } = game?.canvas?.grid?.grid?.getGridPositionFromPixels(\n    changes.x || token.data.x,\n    changes.y || token.data.y,\n  ) || [0, 0];\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  const originalPosition: PointArray = token.data.originalPosition;\n  if (originalPosition[0] === newGridPosition[0] && originalPosition[1] === newGridPosition[1]) return;\n\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  await CanvasAnimation.getAnimation(token.object.movementAnimationName).promise;\n\n  const tokens = game?.scenes?.active?.data?.tokens || [];\n  const tokensInSamePos = tokens.filter((t: any) => {\n    const gridPosition: PointArray | { x: number; y: number } = game?.canvas?.grid?.grid?.getGridPositionFromPixels(\n      t.data.x,\n      t.data.y,\n    ) || [0, 0];\n    return gridPosition[0] === newGridPosition[0] && gridPosition[1] === newGridPosition[1];\n  });\n\n  const tokensInTheOldPos = tokens.filter((t: any) => {\n    const gridPosition: PointArray | { x: number; y: number } = game?.canvas?.grid?.grid?.getGridPositionFromPixels(\n      t.data.x,\n      t.data.y,\n    ) || [0, 0];\n    return gridPosition[0] === originalPosition[0] && gridPosition[1] === originalPosition[1];\n  });\n\n  if (tokensInSamePos.length > 1) {\n    console.log(tokensInSamePos);\n    for (let i = 0; i < tokensInSamePos.length; i++) {\n      const token: TokenDocument = tokensInSamePos[i];\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      token.beforeResize = {\n        x: token.data.x,\n        y: token.data.y,\n      };\n      if (token.data.width === 1) {\n        const size: number = (game?.canvas?.grid?.grid?.w || 0) / 4;\n        token.data.width = 0.5;\n        token.data.height = 0.5;\n\n        let newX = 0;\n        let newY = 0;\n        switch (i) {\n          case 0:\n            newX = token.data.x;\n            newY = token.data.y + size;\n            break;\n          case 1:\n            newX = token.data.x + size * 2;\n            newY = token.data.y + size;\n            break;\n        }\n        token.data.x = newX;\n        token.data.y = newY;\n        await token.update({ width: 0.5, height: 0.5, x: newX, y: newY });\n      }\n    }\n  } else {\n    if (token.data.width === 0.5) {\n      await token.update({ width: 1, height: 1 });\n      const getSnapped: any = game?.canvas?.grid?.grid?.getSnappedPosition(token.data.x, token.data.y) || [0, 0];\n      await token.update({ width: 1, height: 1, x: getSnapped.x, y: getSnapped.y });\n\n      if (tokensInTheOldPos.length === 1) {\n        for (let i = 0; i < tokensInTheOldPos.length; i++) {\n          const token: TokenDocument = tokensInTheOldPos[i];\n          if (token.data.width === 0.5) {\n            token.data.width = 1;\n            token.data.height = 1;\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore\n            await token.update({ width: 1, height: 1, x: token.beforeResize.x, y: token.beforeResize.y });\n          }\n        }\n      }\n    }\n  }\n}\n\nexport function registerHooks(): void {\n  Hooks.on('preUpdateToken', (token: Token, changes: any, data: any) => {\n    if (changes.x || changes.y) {\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      token.data.originalPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(token.data.x, token.data.y) || [\n        0, 0,\n      ];\n    }\n  });\n\n  Hooks.on('updateToken', async (token: TokenDocument, changes: any) => {\n    changeTokensSizeIfInTheSameGridPosition(token, changes);\n  });\n}\n","// Import TypeScript modules\nimport { registerHooks } from './util/setup/hooks.js';\nlet appId = '';\nappId = '3';\nconst globals = {\n  appId,\n};\n\ndeclare global {\n  const TokenAttractor: typeof globals;\n  interface Window {\n    TokenAttractor: typeof globals;\n  }\n  interface LenientGlobalVariableTypes {\n    game: Game;\n  }\n}\n\nwindow.TokenAttractor = globals;\n\nregisterHooks();\n"],"names":[],"mappings":"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"}
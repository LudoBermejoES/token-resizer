{"version":3,"file":"token-resizer.js","sources":["../src/module/libs/resize.ts","../src/module/util/setup/hooks.ts","../src/module/token-resizer.ts"],"sourcesContent":["export function storeOriginalPosition(token: TokenDocument, changes: any) {\n  if (changes.x || changes.y) {\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    token.data.originalPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(token.data.x, token.data.y) || [\n      0, 0,\n    ];\n  }\n}\n\nfunction divideTokensByPosition(newGridPosition: number[], originalPosition: number[]) {\n  const tokens = game?.scenes?.active?.data?.tokens || [];\n  const tokensInSamePos = tokens.filter((t) => {\n    const gridPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(t.data.x, t.data.y) || [0, 0];\n    return gridPosition[0] === newGridPosition[0] && gridPosition[1] === newGridPosition[1];\n  });\n  const tokensInTheOldPos = tokens.filter((t) => {\n    const gridPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(t.data.x, t.data.y) || [0, 0];\n    return gridPosition[0] === originalPosition[0] && gridPosition[1] === originalPosition[1];\n  });\n\n  return {\n    tokensInTheOldPos,\n    tokensInSamePos,\n  };\n}\n\nfunction reduceTokensInTheSamePosition(tokensInSamePos: TokenDocument[]) {\n  for (let i = 0; i < tokensInSamePos.length; i++) {\n    const token = tokensInSamePos[i];\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    token.beforeResize = {\n      x: token.data.x,\n      y: token.data.y,\n    };\n    if (token.data.width === 1) {\n      const size = (game?.canvas?.grid?.grid?.w || 0) / 4;\n      token.data.width = 0.5;\n      token.data.height = 0.5;\n      let newX = 0;\n      let newY = 0;\n      switch (i) {\n        case 0:\n          newX = token.data.x;\n          newY = token.data.y + size;\n          break;\n        case 1:\n          newX = token.data.x + size * 2;\n          newY = token.data.y + size;\n          break;\n      }\n      token.data.x = newX;\n      token.data.y = newY;\n      token.update({ width: 0.5, height: 0.5, x: newX, y: newY });\n    }\n  }\n}\n\nasync function restoreTokensIfTheyAreReduced(token: TokenDocument, tokensInTheOldPos: TokenDocument[]) {\n  if (token.data.width !== 0.5) return;\n  await token.update({ width: 1, height: 1 });\n  const getSnapped: { x: number; y: number } | number[] = game?.canvas?.grid?.grid?.getSnappedPosition(\n    token.data.x,\n    token.data.y,\n  ) || [0, 0];\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  await token.update({ width: 1, height: 1, x: getSnapped.x, y: getSnapped.y });\n  if (tokensInTheOldPos.length === 1) {\n    for (let i = 0; i < tokensInTheOldPos.length; i++) {\n      const token = tokensInTheOldPos[i];\n      if (token.data.width === 0.5) {\n        token.data.width = 1;\n        token.data.height = 1;\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        await token.update({ width: 1, height: 1, x: token.beforeResize.x, y: token.beforeResize.y });\n      }\n    }\n  }\n}\n\nexport async function changeTokensSizeIfInTheSameGridPosition(token: TokenDocument, changes: any) {\n  if (changes.x === undefined && changes.y === undefined) return;\n  if (!game.user?.isGM) return;\n  const newGridPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(\n    changes.x || token.data.x,\n    changes.y || token.data.y,\n  ) || [0, 0];\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  const originalPosition = token.data.originalPosition;\n  if (originalPosition[0] === newGridPosition[0] && originalPosition[1] === newGridPosition[1]) return;\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  await CanvasAnimation.getAnimation(token.object.movementAnimationName).promise;\n\n  const { tokensInTheOldPos, tokensInSamePos } = divideTokensByPosition(newGridPosition, originalPosition);\n\n  tokensInSamePos.length > 1\n    ? reduceTokensInTheSamePosition(tokensInSamePos)\n    : restoreTokensIfTheyAreReduced(token, tokensInTheOldPos);\n}\n","import { changeTokensSizeIfInTheSameGridPosition, storeOriginalPosition } from '../../libs/resize';\n\nexport function registerHooks(): void {\n  Hooks.on('preUpdateToken', storeOriginalPosition);\n  Hooks.on('updateToken', changeTokensSizeIfInTheSameGridPosition);\n}\n","// Import TypeScript modules\nimport { registerHooks } from './util/setup/hooks.js';\nlet appId = '';\nappId = '3';\nconst globals = {\n  appId,\n};\n\ndeclare global {\n  const TokenAttractor: typeof globals;\n  interface Window {\n    TokenAttractor: typeof globals;\n  }\n  interface LenientGlobalVariableTypes {\n    game: Game;\n  }\n}\n\nwindow.TokenAttractor = globals;\n\nregisterHooks();\n"],"names":[],"mappings":"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"}
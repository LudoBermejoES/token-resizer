{"version":3,"file":"token-resizer.js","sources":["../src/module/libs/resize.ts","../src/module/util/setup/socketkib.ts","../src/module/util/setup/hooks.ts","../src/module/token-resizer.ts"],"sourcesContent":["function getObjectFromToken(token: any): TokenDocument | undefined {\n  if (!token.data) {\n    const tokens = game?.scenes?.active?.data?.tokens;\n    if (tokens) {\n      return <TokenDocument>tokens.find((t) => t.data._id === token._id);\n    }\n  } else {\n    return token;\n  }\n  return undefined;\n}\n\nexport function storeOriginalPosition(tokenP: TokenDocument | Token, changes: any) {\n  if (!game?.user?.isGM) {\n    return;\n  }\n  const token: TokenDocument | undefined = getObjectFromToken(tokenP);\n  if (!token) return;\n\n  if (changes.x || changes.y) {\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    token.data.originalPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(token.data.x, token.data.y) || [\n      0, 0,\n    ];\n  }\n}\n\nfunction divideTokensByPosition(newGridPosition: number[], originalPosition: number[]) {\n  const tokens = game?.scenes?.active?.data?.tokens || [];\n  const tokensInSamePos = tokens.filter((t) => {\n    const gridPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(t.data.x, t.data.y) || [0, 0];\n    return gridPosition[0] === newGridPosition[0] && gridPosition[1] === newGridPosition[1];\n  });\n  const tokensInTheOldPos = tokens.filter((t) => {\n    const gridPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(t.data.x, t.data.y) || [0, 0];\n    return gridPosition[0] === originalPosition[0] && gridPosition[1] === originalPosition[1];\n  });\n\n  return {\n    tokensInTheOldPos,\n    tokensInSamePos,\n  };\n}\n\nfunction reduceTokensInTheSamePosition(tokensInSamePos: TokenDocument[]) {\n  if (tokensInSamePos.length > 2) return;\n  for (let i = 0; i < tokensInSamePos.length; i++) {\n    const token = tokensInSamePos[i];\n    if (token.data.width === 1) {\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      token.beforeResize = {\n        x: token.data.x,\n        y: token.data.y,\n      };\n    }\n    const size = (game?.canvas?.grid?.grid?.w || 0) / 4;\n    token.data.width = 0.5;\n    token.data.height = 0.5;\n    let newX = 0;\n    let newY = 0;\n    switch (i) {\n      case 0:\n        newX = token.data.x;\n        newY = token.data.y + size;\n        break;\n      case 1:\n        newX = token.data.x + size * 2;\n        newY = token.data.y + size;\n        break;\n    }\n    token.data.x = newX;\n    token.data.y = newY;\n    token.update({ width: 0.5, height: 0.5, x: newX, y: newY });\n  }\n}\n\nasync function restoreTokensIfTheyAreReduced(token: TokenDocument | Token, tokensInTheOldPos: TokenDocument[]) {\n  if (token.data.width !== 0.5) return;\n  if (token instanceof TokenDocument) {\n    await token.update({ width: 1, height: 1 });\n  } else if (token instanceof Token) {\n    await token.data.update({ width: 1, height: 1 });\n  }\n\n  const getSnapped: { x: number; y: number } | number[] = game?.canvas?.grid?.grid?.getSnappedPosition(\n    token.data.x,\n    token.data.y,\n  ) || [0, 0];\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  await token.update({ width: 1, height: 1, x: getSnapped.x, y: getSnapped.y });\n  if (tokensInTheOldPos.length === 1) {\n    for (let i = 0; i < tokensInTheOldPos.length; i++) {\n      const token = tokensInTheOldPos[i];\n      if (token.data.width === 0.5) {\n        token.data.width = 1;\n        token.data.height = 1;\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        await token.update({ width: 1, height: 1, x: token.beforeResize.x, y: token.beforeResize.y });\n      }\n    }\n  }\n}\n\nexport async function changeTokensSizeIfInTheSameGridPosition(tokenP: TokenDocument | Token, changes: any) {\n  if (!game?.user?.isGM) {\n    return;\n  }\n\n  const token: TokenDocument | undefined = getObjectFromToken(tokenP);\n  if (!token) return;\n\n  if (changes.x === undefined && changes.y === undefined) return;\n  //  if (!game.user?.isGM) return;\n  const newGridPosition = game?.canvas?.grid?.grid?.getGridPositionFromPixels(\n    changes.x || token.data.x,\n    changes.y || token.data.y,\n  ) || [0, 0];\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  const originalPosition = token.data.originalPosition;\n  if (originalPosition[0] === newGridPosition[0] && originalPosition[1] === newGridPosition[1]) return;\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  await CanvasAnimation.getAnimation(token.object.movementAnimationName).promise;\n\n  const { tokensInTheOldPos, tokensInSamePos } = divideTokensByPosition(newGridPosition, originalPosition);\n\n  tokensInSamePos.length > 1\n    ? reduceTokensInTheSamePosition(tokensInSamePos)\n    : restoreTokensIfTheyAreReduced(token, tokensInTheOldPos);\n}\n","import { changeTokensSizeIfInTheSameGridPosition, storeOriginalPosition } from '../../libs/resize';\nconst MODULE_NAME = 'token-resizer' as const;\n\nconst functionsToRegister = {\n  changeTokensSizeIfInTheSameGridPosition,\n  storeOriginalPosition,\n} as const;\n\ninterface SockerLib {\n  registerModule(mudeltName: string): SockerLibSocket;\n}\nexport interface SockerLibSocket {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  register(alias: string, func: (...args: any[]) => any): void;\n  executeAsUser<T extends keyof typeof functionsToRegister>(\n    alias: T,\n    userId: string,\n    ...args: Parameters<typeof functionsToRegister[T]>\n  ): Promise<ReturnType<typeof functionsToRegister[T]>>;\n  executeForEveryone<T extends keyof typeof functionsToRegister>(\n    alias: T,\n    ...args: Parameters<typeof functionsToRegister[T]>\n  ): Promise<void>;\n}\ndeclare global {\n  const socketlib: SockerLib;\n}\n\nexport function registerFunctions(): void {\n  console.log('REGISTRO LAS OPCIONES');\n  TokenResizer.socket = socketlib.registerModule(MODULE_NAME);\n  for (const [alias, func] of Object.entries(functionsToRegister)) {\n    console.log(alias, func);\n    TokenResizer.socket.register(alias, func);\n  }\n}\n","import { changeTokensSizeIfInTheSameGridPosition, storeOriginalPosition } from '../../libs/resize';\nimport { registerFunctions } from './socketkib';\n\nexport function registerHooks(): void {\n  Hooks.once('socketlib.ready', registerFunctions);\n  Hooks.on('preUpdateToken', storeOriginalPosition);\n  Hooks.on('updateToken', changeTokensSizeIfInTheSameGridPosition);\n}\n","// Import TypeScript modules\nimport { registerHooks } from './util/setup/hooks.js';\nimport { registerFunctions, SockerLibSocket } from './util/setup/socketkib';\nconst globals = {};\n\ndeclare global {\n  const TokenResizer: typeof globals & { socket: SockerLibSocket };\n  interface Window {\n    TokenResizer: typeof globals;\n  }\n  interface LenientGlobalVariableTypes {\n    game: Game;\n  }\n}\n\nwindow.TokenResizer = globals;\n\nregisterHooks();\n"],"names":[],"mappings":"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"}